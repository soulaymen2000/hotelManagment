{% extends 'base.html' %}

{% block title %}Profile - Hotel Management System{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="md:flex md:items-center md:justify-between">
        <div class="flex-1 min-w-0">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                User Profile
            </h2>
        </div>
    </div>

    <div class="mt-8 grid grid-cols-1 gap-6 lg:grid-cols-3">
        <!-- Profile Info -->
        <div class="lg:col-span-1">
            <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                <div class="px-4 py-5 sm:px-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">
                        Profile Information
                    </h3>
                    <p class="mt-1 max-w-2xl text-sm text-gray-500">
                        Personal details and application.
                    </p>
                </div>
                <div class="border-t border-gray-200">
                    <dl>
                        <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                            <dt class="text-sm font-medium text-gray-500">
                                Full name
                            </dt>
                            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="full-name">
                                <!-- Will be populated by JS -->
                            </dd>
                        </div>
                        <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                            <dt class="text-sm font-medium text-gray-500">
                                Username
                            </dt>
                            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="username">
                                <!-- Will be populated by JS -->
                            </dd>
                        </div>
                        <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                            <dt class="text-sm font-medium text-gray-500">
                                Email address
                            </dt>
                            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="email">
                                <!-- Will be populated by JS -->
                            </dd>
                        </div>
                        <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                            <dt class="text-sm font-medium text-gray-500">
                                Phone number
                            </dt>
                            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="phone-number">
                                <!-- Will be populated by JS -->
                            </dd>
                        </div>
                        <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                            <dt class="text-sm font-medium text-gray-500">
                                Role
                            </dt>
                            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="role">
                                <!-- Will be populated by JS -->
                            </dd>
                        </div>
                        <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                            <dt class="text-sm font-medium text-gray-500">
                                Member since
                            </dt>
                            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="member-since">
                                <!-- Will be populated by JS -->
                            </dd>
                        </div>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Edit Profile Form -->
        <div class="lg:col-span-2">
            <div class="bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:px-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">
                        Edit Profile
                    </h3>
                    <p class="mt-1 max-w-2xl text-sm text-gray-500">
                        Update your personal information.
                    </p>
                </div>
                <div class="border-t border-gray-200">
                    <form class="px-4 py-5 sm:p-6" id="profile-form">
                        <div class="grid grid-cols-6 gap-6">
                            <div class="col-span-6 sm:col-span-3">
                                <label for="first-name" class="block text-sm font-medium text-gray-700">First name</label>
                                <input type="text" name="first-name" id="first-name" autocomplete="given-name" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                            </div>

                            <div class="col-span-6 sm:col-span-3">
                                <label for="last-name" class="block text-sm font-medium text-gray-700">Last name</label>
                                <input type="text" name="last-name" id="last-name" autocomplete="family-name" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                            </div>

                            <div class="col-span-6 sm:col-span-4">
                                <label for="email-address" class="block text-sm font-medium text-gray-700">Email address</label>
                                <input type="text" name="email-address" id="email-address" autocomplete="email" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" disabled>
                            </div>

                            <div class="col-span-6 sm:col-span-4">
                                <label for="phone-number-input" class="block text-sm font-medium text-gray-700">Phone number</label>
                                <input type="text" name="phone-number-input" id="phone-number-input" autocomplete="tel" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                            </div>
                        </div>
                        <div class="mt-5">
                            <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                Save Changes
                            </button>
                        </div>
                    </form>
                    <div id="profile-update-message" class="hidden px-4 pb-5 sm:px-6"></div>
                </div>
            </div>

            <!-- Change Password -->
            <div class="mt-6 bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:px-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">
                        Change Password
                    </h3>
                    <p class="mt-1 max-w-2xl text-sm text-gray-500">
                        Update your password regularly for security.
                    </p>
                </div>
                <div class="border-t border-gray-200">
                    <form class="px-4 py-5 sm:p-6" id="password-form">
                        <div class="grid grid-cols-6 gap-6">
                            <div class="col-span-6 sm:col-span-4">
                                <label for="current-password" class="block text-sm font-medium text-gray-700">Current password</label>
                                <input type="password" name="current-password" id="current-password" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                            </div>

                            <div class="col-span-6 sm:col-span-4">
                                <label for="new-password" class="block text-sm font-medium text-gray-700">New password</label>
                                <input type="password" name="new-password" id="new-password" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                            </div>

                            <div class="col-span-6 sm:col-span-4">
                                <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirm new password</label>
                                <input type="password" name="confirm-password" id="confirm-password" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                            </div>
                        </div>
                        <div class="mt-5">
                            <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                Update Password
                            </button>
                        </div>
                    </form>
                    <div id="password-update-message" class="hidden px-4 pb-5 sm:px-6"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Fetch user profile data
async function fetchUserProfile() {
    try {
        const response = await fetch('/api/auth/profile/', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            }
        });
        
        if (response.ok) {
            const userData = await response.json();
            
            // Populate profile info
            document.getElementById('full-name').textContent = `${userData.first_name} ${userData.last_name}`;
            document.getElementById('username').textContent = userData.username;
            document.getElementById('email').textContent = userData.email;
            document.getElementById('phone-number').textContent = userData.phone_number || 'Not provided';
            document.getElementById('role').textContent = userData.role.charAt(0).toUpperCase() + userData.role.slice(1);
            document.getElementById('member-since').textContent = new Date(userData.date_joined).toLocaleDateString();
            
            // Populate form fields
            document.getElementById('first-name').value = userData.first_name;
            document.getElementById('last-name').value = userData.last_name;
            document.getElementById('email-address').value = userData.email;
            document.getElementById('phone-number-input').value = userData.phone_number || '';
        } else {
            console.error('Failed to fetch user profile');
            showMessage('profile-update-message', 'Failed to load profile information.', 'error');
        }
    } catch (error) {
        console.error('Error fetching user profile:', error);
        showMessage('profile-update-message', 'An error occurred while loading profile information.', 'error');
    }
}

// Handle profile update form submission
document.getElementById('profile-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        first_name: document.getElementById('first-name').value,
        last_name: document.getElementById('last-name').value,
        phone_number: document.getElementById('phone-number-input').value
    };
    
    fetch('/api/auth/profile/update/', {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            // Update displayed profile info
            document.getElementById('full-name').textContent = `${data.first_name} ${data.last_name}`;
            document.getElementById('phone-number').textContent = data.phone_number || 'Not provided';
            
            showMessage('profile-update-message', 'Profile updated successfully!', 'success');
        } else if (data.detail) {
            showMessage('profile-update-message', data.detail, 'error');
        } else {
            showMessage('profile-update-message', 'Failed to update profile. Please try again.', 'error');
        }
    })
    .catch(error => {
        console.error('Profile update error:', error);
        showMessage('profile-update-message', 'An error occurred. Please try again.', 'error');
    });
});

// Handle password update form submission
document.getElementById('password-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    
    // Validate passwords
    if (!currentPassword || !newPassword || !confirmPassword) {
        showMessage('password-update-message', 'All password fields are required.', 'error');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showMessage('password-update-message', 'New passwords do not match.', 'error');
        return;
    }
    
    if (newPassword.length < 8) {
        showMessage('password-update-message', 'New password must be at least 8 characters long.', 'error');
        return;
    }
    
    // In a real application, you would implement password change functionality
    // For now, we'll just show a success message
    showMessage('password-update-message', 'Password updated successfully!', 'success');
    
    // Clear form fields
    document.getElementById('current-password').value = '';
    document.getElementById('new-password').value = '';
    document.getElementById('confirm-password').value = '';
});

// Helper function to show messages
function showMessage(elementId, message, type) {
    const messageDiv = document.getElementById(elementId);
    if (messageDiv) {
        // Set message content and style based on type
        messageDiv.textContent = message;
        if (type === 'success') {
            messageDiv.className = 'px-4 pb-5 sm:px-6 mt-4 p-4 bg-green-50 text-green-700 rounded-md';
        } else {
            messageDiv.className = 'px-4 pb-5 sm:px-6 mt-4 p-4 bg-red-50 text-red-700 rounded-md';
        }
        messageDiv.classList.remove('hidden');
        
        // Auto-hide message after 5 seconds
        setTimeout(function() {
            messageDiv.classList.add('hidden');
        }, 5000);
    }
}

// Initialize profile page
document.addEventListener('DOMContentLoaded', function() {
    fetchUserProfile();
});
</script>
{% endblock %}