<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Hotel Management System</title>
    <!-- Local Tailwind CSS -->
    {% load static %}
    <link href="{% static 'css/tailwind.css' %}" rel="stylesheet">
    <style>
        /* Additional styles to ensure no external dependencies */
        .hidden { display: none; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Sign in to your account
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600">
                    Please enter your credentials to access the system
                </p>
            </div>
            <form class="mt-8 space-y-6" id="login-form" method="post">
                {% csrf_token %}
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email-address" class="sr-only">Email address</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Email address">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Password">
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-900">
                            Remember me
                        </label>
                    </div>

                    <div class="text-sm">
                        <a href="#" class="font-medium text-blue-600 hover:text-blue-500">
                            Forgot your password?
                        </a>
                    </div>
                </div>

                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Sign in
                    </button>
                </div>
            </form>
            <div class="text-sm text-center">
                <p class="text-gray-600">
                    Don't have an account?
                    <a href="{% url 'register' %}" class="font-medium text-blue-600 hover:text-blue-500">
                        Register here
                    </a>
                </p>
            </div>
            <!-- Error message container -->
            <div id="error-message" class="hidden rounded-md bg-red-50 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800" id="error-text">
                            <!-- Error message will appear here -->
                        </h3>
                    </div>
                </div>
            </div>
            
            <!-- Success message container -->
            <div id="success-message" class="hidden rounded-md bg-green-50 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-green-800">
                            Login successful! Redirecting...
                        </h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Extreme isolation - create a completely sandboxed environment
    (function() {
        // Wait for the DOM to be fully loaded
        function domReady(callback) {
            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", callback);
            } else {
                callback();
            }
        }

        // Completely isolated login handler
        function initLoginForm() {
            try {
                var loginForm = document.getElementById('login-form');
                
                if (!loginForm) {
                    console.error('Login form not found');
                    return;
                }
                
                // Completely remove any existing event listeners by cloning
                var newLoginForm = loginForm.cloneNode(true);
                loginForm.parentNode.replaceChild(newLoginForm, loginForm);
                loginForm = newLoginForm;
                
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    
                    var email = document.getElementById('email-address').value;
                    var password = document.getElementById('password').value;
                    var errorMessage = document.getElementById('error-message');
                    var errorText = document.getElementById('error-text');
                    var successMessage = document.getElementById('success-message');
                    var submitButton = loginForm.querySelector('button[type="submit"]');
                    
                    // Hide any previous messages
                    if (errorMessage) {
                        errorMessage.classList.add('hidden');
                    }
                    if (successMessage) {
                        successMessage.classList.add('hidden');
                    }
                    
                    console.log('Attempting login with email:', email);
                    
                    // Validate inputs
                    if (!email || !password) {
                        showError('Please enter both email and password.');
                        return;
                    }
                    
                    // Disable submit button and show loading state
                    submitButton.disabled = true;
                    var originalButtonText = submitButton.innerHTML;
                    submitButton.innerHTML = 'Signing in...';
                    
                    // Create form data for traditional POST submission
                    var formData = new FormData();
                    formData.append('email', email);
                    formData.append('password', password);
                    // Add CSRF token
                    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                    
                    // Submit form using traditional POST method
                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', '/accounts/login/', true);
                    
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4) {
                            console.log('Response status:', xhr.status);
                            console.log('Response headers:', xhr.getAllResponseHeaders());
                            
                            // Re-enable submit button
                            submitButton.disabled = false;
                            submitButton.innerHTML = originalButtonText;
                            
                            try {
                                var data = JSON.parse(xhr.responseText);
                                console.log('Response data:', data);
                                
                                if (xhr.status === 200 && data.success) {
                                    // Show success message
                                    if (successMessage) {
                                        successMessage.classList.remove('hidden');
                                    }
                                    
                                    // Use redirect_url from backend if available
                                    if (data.redirect_url) {
                                        setTimeout(function() {
                                            window.location.href = data.redirect_url;
                                        }, 1000);
                                    } else {
                                        // Fallback to role-based redirection
                                        setTimeout(function() {
                                            // Determine redirect URL based on user role
                                            if (data.user_role === 'admin') {
                                                window.location.href = '/dashboards/admin/';
                                            } else if (data.user_role === 'reception') {
                                                window.location.href = '/dashboards/reception/';
                                            } else {
                                                window.location.href = '/dashboards/guest/';
                                            }
                                        }, 1000);
                                    }
                                } else {
                                    // Display error message
                                    var errorMsg = 'Login failed. Please check your credentials.';
                                    if (data.error) {
                                        errorMsg = data.error;
                                    } else if (data.detail) {
                                        errorMsg = data.detail;
                                    }
                                    showError(errorMsg);
                                }
                            } catch (error) {
                                console.error('Login error:', error);
                                console.error('Error stack:', error.stack);
                                // If we can't parse JSON, it might be a redirect response
                                if (xhr.status === 200 && xhr.responseText.includes('<html')) {
                                    // Page was rendered, which means login was successful
                                    window.location.reload();
                                } else if (xhr.status === 302) {
                                    // Redirect response
                                    var redirectUrl = xhr.getResponseHeader('Location');
                                    if (redirectUrl) {
                                        window.location.href = redirectUrl;
                                    } else {
                                        window.location.href = '/dashboards/';
                                    }
                                } else {
                                    showError('An error occurred during login. Please try again.');
                                }
                            }
                        }
                    };
                    
                    // Send the request
                    xhr.send(formData);
                });
                
                // Helper function to show error messages
                function showError(message) {
                    var errorMessage = document.getElementById('error-message');
                    var errorText = document.getElementById('error-text');
                    
                    if (errorMessage && errorText) {
                        errorText.textContent = message;
                        errorMessage.classList.remove('hidden');
                        
                        // Auto-hide error after 5 seconds
                        setTimeout(function() {
                            errorMessage.classList.add('hidden');
                        }, 5000);
                    }
                }
            } catch (error) {
                console.error('Error initializing login form:', error);
                console.error('Error stack:', error.stack);
            }
        }
        
        // Initialize when DOM is ready
        domReady(initLoginForm);
    })();
    
    // Additional protection - override any external attempts to modify our functions
    window.addEventListener('error', function(e) {
        // Prevent the giveFreely.tsx error from breaking our login
        if (e.message && e.message.indexOf('giveFreely') >= 0) {
            e.preventDefault();
            e.stopPropagation();
            console.warn('Blocked external error:', e.message);
            return false;
        }
    }, true);
    </script>
</body>
</html>