{% extends 'base.html' %}

{% block title %}Booking Management - Hotel Management System{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="md:flex md:items-center md:justify-between">
        <div class="flex-1 min-w-0">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                Booking Management
            </h2>
        </div>
        <div class="mt-4 flex md:mt-0 md:ml-4">
            <button type="button" class="ml-3 inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Create Booking
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="mt-6 bg-white shadow rounded-lg p-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div>
                <label for="status-filter" class="block text-sm font-medium text-gray-700">Status</label>
                <select id="status-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="checked_in">Checked In</option>
                    <option value="checked_out">Checked Out</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            <div>
                <label for="date-filter" class="block text-sm font-medium text-gray-700">Date Range</label>
                <select id="date-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                    <option value="">All Dates</option>
                    <option value="today">Today</option>
                    <option value="this_week">This Week</option>
                    <option value="this_month">This Month</option>
                </select>
            </div>
            <div>
                <label for="room-filter" class="block text-sm font-medium text-gray-700">Room</label>
                <select id="room-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                    <option value="">All Rooms</option>
                    <!-- Rooms will be populated by JavaScript -->
                </select>
            </div>
            <div class="flex items-end">
                <button id="apply-filters" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Apply Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Booking Status Legend -->
    <div class="mt-6">
        <h3 class="text-lg font-medium text-gray-900">Booking Status Legend</h3>
        <div class="mt-2 flex flex-wrap gap-4">
            <div class="flex items-center">
                <div class="w-4 h-4 bg-yellow-500 rounded-full"></div>
                <span class="ml-2 text-sm text-gray-600">Pending</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 bg-blue-500 rounded-full"></div>
                <span class="ml-2 text-sm text-gray-600">Confirmed</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 bg-green-500 rounded-full"></div>
                <span class="ml-2 text-sm text-gray-600">Checked In</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 bg-gray-500 rounded-full"></div>
                <span class="ml-2 text-sm text-gray-600">Checked Out</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 bg-red-500 rounded-full"></div>
                <span class="ml-2 text-sm text-gray-600">Cancelled</span>
            </div>
        </div>
    </div>

    <!-- Bookings Table -->
    <div class="mt-6 bg-white shadow overflow-hidden sm:rounded-lg">
        <div class="px-4 py-5 sm:px-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Bookings</h3>
            <p class="mt-1 max-w-2xl text-sm text-gray-500">List of all bookings in the system.</p>
        </div>
        <div class="border-t border-gray-200">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Booking ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Guest</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Room</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Check-in</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Check-out</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Guests</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Price</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="bookings-table-body">
                        <!-- Rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <div class="mt-6 flex items-center justify-between">
        <div class="text-sm text-gray-700">
            Showing <span id="page-info">0</span> of <span id="total-bookings">0</span> bookings
        </div>
        <div class="flex space-x-2">
            <button id="prev-page" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Previous
            </button>
            <button id="next-page" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Next
            </button>
        </div>
    </div>
</div>

<script>
// Global variables for pagination
let currentPage = 1;
let totalPages = 1;
let allBookings = [];

// Fetch bookings data
async function fetchBookings() {
    try {
        const response = await fetch('/api/bookings/reception/', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            }
        });
        
        if (response.ok) {
            const bookings = await response.json();
            allBookings = bookings;
            displayBookings(bookings);
            populateRoomFilter(bookings);
        } else {
            console.error('Failed to fetch bookings');
        }
    } catch (error) {
        console.error('Error fetching bookings:', error);
    }
}

// Populate room filter dropdown
function populateRoomFilter(bookings) {
    const roomFilter = document.getElementById('room-filter');
    
    // Get unique rooms
    const rooms = [...new Set(bookings.map(booking => booking.room_number))];
    
    // Clear existing options except the first one
    roomFilter.innerHTML = '<option value="">All Rooms</option>';
    
    // Add room options
    rooms.forEach(roomNumber => {
        const option = document.createElement('option');
        option.value = roomNumber;
        option.textContent = `Room ${roomNumber}`;
        roomFilter.appendChild(option);
    });
}

// Display bookings in the table
function displayBookings(bookings) {
    const tableBody = document.getElementById('bookings-table-body');
    tableBody.innerHTML = '';
    
    // Update total bookings count
    document.getElementById('total-bookings').textContent = bookings.length;
    
    // Display current page info
    document.getElementById('page-info').textContent = `${Math.min(bookings.length, 10)} bookings`;
    
    // Display bookings (limit to 10 for now)
    bookings.slice(0, 10).forEach(booking => {
        const row = document.createElement('tr');
        
        // Determine status color
        let statusClass = '';
        let statusText = '';
        
        switch(booking.status) {
            case 'pending':
                statusClass = 'bg-yellow-100 text-yellow-800';
                statusText = 'Pending';
                break;
            case 'confirmed':
                statusClass = 'bg-blue-100 text-blue-800';
                statusText = 'Confirmed';
                break;
            case 'checked_in':
                statusClass = 'bg-green-100 text-green-800';
                statusText = 'Checked In';
                break;
            case 'checked_out':
                statusClass = 'bg-gray-100 text-gray-800';
                statusText = 'Checked Out';
                break;
            case 'cancelled':
                statusClass = 'bg-red-100 text-red-800';
                statusText = 'Cancelled';
                break;
            default:
                statusClass = 'bg-gray-100 text-gray-800';
                statusText = booking.status;
        }
        
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${booking.id}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${booking.guest_email}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${booking.room_number}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(booking.check_in_date).toLocaleDateString()}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(booking.check_out_date).toLocaleDateString()}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${booking.num_guests}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${parseFloat(booking.total_price).toFixed(2)}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                    ${statusText}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button class="text-blue-600 hover:text-blue-900 mr-3">View</button>
                <button class="text-green-600 hover:text-green-900 mr-3">Edit</button>
                <button class="text-red-600 hover:text-red-900">Cancel</button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

// Apply filters
document.getElementById('apply-filters').addEventListener('click', function() {
    const statusFilter = document.getElementById('status-filter').value;
    const dateFilter = document.getElementById('date-filter').value;
    const roomFilter = document.getElementById('room-filter').value;
    
    let filteredBookings = [...allBookings];
    
    if (statusFilter) {
        filteredBookings = filteredBookings.filter(booking => booking.status === statusFilter);
    }
    
    if (roomFilter) {
        filteredBookings = filteredBookings.filter(booking => booking.room_number === roomFilter);
    }
    
    // Date filtering would be implemented here in a real application
    
    displayBookings(filteredBookings);
});

// Initialize booking management page
document.addEventListener('DOMContentLoaded', function() {
    fetchBookings();
});
</script>
{% endblock %}