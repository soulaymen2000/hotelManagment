{% extends 'base.html' %}

{% block title %}Audit Log - Hotel Management System{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="md:flex md:items-center md:justify-between">
        <div class="flex-1 min-w-0">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                Audit Log
            </h2>
        </div>
    </div>

    <!-- Filters -->
    <div class="mt-6 bg-white shadow rounded-lg p-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div>
                <label for="action-filter" class="block text-sm font-medium text-gray-700">Action</label>
                <select id="action-filter"
                    class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                    <option value="">All Actions</option>
                    <option value="create">Create</option>
                    <option value="update">Update</option>
                    <option value="delete">Delete</option>
                    <option value="login">Login</option>
                    <option value="logout">Logout</option>
                    <option value="check_in">Check In</option>
                    <option value="check_out">Check Out</option>
                    <option value="room_status_change">Room Status Change</option>
                    <option value="booking_status_change">Booking Status Change</option>
                </select>
            </div>
            <div>
                <label for="user-filter" class="block text-sm font-medium text-gray-700">User</label>
                <select id="user-filter"
                    class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                    <option value="">All Users</option>
                    <!-- Users will be populated by JavaScript -->
                </select>
            </div>
            <div>
                <label for="date-filter" class="block text-sm font-medium text-gray-700">Date Range</label>
                <select id="date-filter"
                    class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                    <option value="">All Dates</option>
                    <option value="today">Today</option>
                    <option value="this_week">This Week</option>
                    <option value="this_month">This Month</option>
                    <option value="last_month">Last Month</option>
                </select>
            </div>
            <div class="flex items-end">
                <button id="apply-filters"
                    class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Apply Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Audit Log Table -->
    <div class="mt-6 bg-white shadow overflow-hidden sm:rounded-lg">
        <div class="px-4 py-5 sm:px-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Activity Log</h3>
            <p class="mt-1 max-w-2xl text-sm text-gray-500">List of all system activities.</p>
        </div>
        <div class="border-t border-gray-200">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Timestamp</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                User</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Action</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Model</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Object ID</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Description</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="audit-log-table-body">
                        <!-- Rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <div class="mt-6 flex items-center justify-between">
        <div class="text-sm text-gray-700">
            Showing <span id="page-info">0</span> of <span id="total-logs">0</span> entries
        </div>
        <div class="flex space-x-2">
            <button id="prev-page"
                class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Previous
            </button>
            <button id="next-page"
                class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Next
            </button>
        </div>
    </div>

    <script>
        let allAuditLogs = [];

        // Fetch audit logs from API
        async function fetchAuditLogs() {
            try {
                const response = await fetch('/api/audit/', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                if (response.ok) {
                    const logs = await response.json();
                    allAuditLogs = logs;
                    displayAuditLogs(logs);
                    populateUserFilter(logs);
                } else {
                    console.error('Failed to fetch audit logs');
                    document.getElementById('audit-log-table-body').innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-red-500">Failed to load audit logs. Please try again.</td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error fetching audit logs:', error);
                document.getElementById('audit-log-table-body').innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-4 text-center text-red-500">Error loading logs.</td>
                </tr>
            `;
            }
        }

        // Display audit logs in the table
        function displayAuditLogs(logs) {
            const tableBody = document.getElementById('audit-log-table-body');
            tableBody.innerHTML = '';

            // Update total logs count
            document.getElementById('total-logs').textContent = logs.length;

            // Display current page info
            document.getElementById('page-info').textContent = `${Math.min(logs.length, 10)} entries`;

            if (logs.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">No audit logs found.</td>
                    </tr>
                `;
                return;
            }

            // Display logs (limit to 10 for now)
            logs.slice(0, 10).forEach(log => {
                const row = document.createElement('tr');

                // Format action with color coding
                let actionClass = '';
                let actionText = '';

                switch (log.action) {
                    case 'create':
                        actionClass = 'bg-green-100 text-green-800';
                        actionText = 'Create';
                        break;
                    case 'update':
                        actionClass = 'bg-blue-100 text-blue-800';
                        actionText = 'Update';
                        break;
                    case 'delete':
                        actionClass = 'bg-red-100 text-red-800';
                        actionText = 'Delete';
                        break;
                    case 'login':
                        actionClass = 'bg-purple-100 text-purple-800';
                        actionText = 'Login';
                        break;
                    case 'logout':
                        actionClass = 'bg-yellow-100 text-yellow-800';
                        actionText = 'Logout';
                        break;
                    case 'check_in':
                        actionClass = 'bg-indigo-100 text-indigo-800';
                        actionText = 'Check In';
                        break;
                    case 'check_out':
                        actionClass = 'bg-pink-100 text-pink-800';
                        actionText = 'Check Out';
                        break;
                    case 'room_status_change':
                        actionClass = 'bg-teal-100 text-teal-800';
                        actionText = 'Room Status Change';
                        break;
                    case 'booking_status_change':
                        actionClass = 'bg-orange-100 text-orange-800';
                        actionText = 'Booking Status Change';
                        break;
                    default:
                        actionClass = 'bg-gray-100 text-gray-800';
                        actionText = log.action;
                }

                // Handle user display safely
                const userDisplay = log.user_details ? log.user_details.email : (log.user || 'System/Unknown');

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(log.created_at).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${userDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${actionClass}">
                            ${actionText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.model_type}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.object_id}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${log.description}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Populate user filter dropdown
        function populateUserFilter(logs) {
            const userFilter = document.getElementById('user-filter');
            // Extract unique emails/usernames
            const users = [...new Set(logs.map(log => log.user_details ? log.user_details.email : log.user).filter(Boolean))];

            // Clear existing (except first)
            userFilter.innerHTML = '<option value="">All Users</option>';

            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                userFilter.appendChild(option);
            });
        }

        // Apply filters
        document.getElementById('apply-filters').addEventListener('click', function () {
            const actionFilter = document.getElementById('action-filter').value;
            const userFilter = document.getElementById('user-filter').value;
            const dateFilter = document.getElementById('date-filter').value;

            let filteredLogs = [...allAuditLogs];

            if (actionFilter) {
                filteredLogs = filteredLogs.filter(log => log.action === actionFilter);
            }

            if (userFilter) {
                filteredLogs = filteredLogs.filter(log => {
                    const logUser = log.user_details ? log.user_details.email : log.user;
                    return logUser === userFilter;
                });
            }

            // Date filtering would be implemented here in a real application

            displayAuditLogs(filteredLogs);
        });

        // Initialize audit log page
        document.addEventListener('DOMContentLoaded', function () {
            fetchAuditLogs();
        });
    </script>
    {% endblock %}